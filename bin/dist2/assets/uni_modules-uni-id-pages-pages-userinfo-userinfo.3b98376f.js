import{_ as e,D as i,o as t,c as a,w as s,J as n,b as o,m as l,i as c,Y as r,Z as u,$ as d,N as h,O as p,n as m,a0 as f,f as g,g as y,A as b,z as w,q as k,a1 as _,a2 as v,a as I,d as C,p as x,s as S,e as M,F as P}from"./index-eb11052f.js";import{_ as B,a as L}from"./uni-list.71935a35.js";import{_ as A}from"./uni-popup-dialog.dbe43988.js";const N=e({name:"cloud-image",emits:["click"],props:{mode:{type:String,default:()=>"widthFix"},src:{default:()=>""},width:{type:String,default:()=>"100rpx"},height:{type:String,default:()=>"100rpx"}},watch:{src:{handler(e){e&&"cloud://"==e.substring(0,8)?i.getTempFileURL({fileList:[e]}).then((e=>{this.cSrc=e.fileList[0].tempFileURL})):this.cSrc=e},immediate:!0}},methods:{onClick(){this.$emit("click")}},data:()=>({cSrc:!1})},[["render",function(e,i,r,u,d,h){const p=l,m=c;return t(),a(m,{onClick:h.onClick,style:n([{width:r.width,height:r.height},{"justify-content":"center"}])},{default:s((()=>[d.cSrc?(t(),a(p,{key:0,style:n({width:r.width,height:r.height}),src:d.cSrc,mode:r.mode},null,8,["style","src","mode"])):o("",!0)])),_:1},8,["onClick","style"])}]]);const T=e({data:()=>({isPC:!1}),props:{width:{type:String,default:()=>"50px"},height:{type:String,default:()=>"50px"},border:{type:Boolean,default:()=>!1}},async mounted(){this.isPC=!["ios","android"].includes(r().platform)},computed:{hasLogin:()=>u.hasLogin,userInfo:()=>u.userInfo,avatar_file:()=>u.userInfo.avatar_file},methods:{setAvatarFile(e){d.updateUserInfo({avatar_file:e})},async bindchooseavatar(e){let t=e.detail.avatarUrl,a={extname:t.split(".")[t.split(".").length-1],name:"",url:""},s=this.userInfo._id+""+Date.now();a.name=s;try{h({title:"更新中",mask:!0});let{fileID:e}=await i.uploadFile({filePath:t,cloudPath:s,fileType:"image"});a.url=e,p()}catch(n){console.error(n)}console.log("avatar_file",a),this.setAvatarFile(a)},uploadAvatarImg(e){if(!this.hasLogin)return m({url:"/uni_modules/uni-id-pages/pages/login/login-withoutpwd"});const t={quality:100,width:600,height:600,resize:!0};f({count:1,crop:t,success:async e=>{let a=e.tempFiles[0],s={extname:a.name.split(".")[a.name.split(".").length-1]},n=e.tempFilePaths[0];n=await new Promise((e=>{this.isPC||m({url:"/uni_modules/uni-id-pages/pages/userinfo/cropImage/cropImage?path="+n+`&options=${JSON.stringify(t)}`,animationType:"fade-in",events:{success:i=>{e(i)}},complete(e){}})}));let o=this.userInfo._id+""+Date.now();s.name=o,h({title:"更新中",mask:!0});let{fileID:l}=await i.uploadFile({filePath:n,cloudPath:o,fileType:"image"});s.url=l,p(),this.setAvatarFile(s)}})}}},[["render",function(e,i,o,l,c,r){const u=g(y("cloud-image"),N),d=g(y("uni-icons"),b),h=k;return t(),a(h,{"open-type":"chooseAvatar",onChooseavatar:r.bindchooseavatar,onClick:r.uploadAvatarImg,class:w(["box",{showBorder:o.border}]),style:n({width:o.width,height:o.height,lineHeight:o.height})},{default:s((()=>[r.avatar_file?(t(),a(u,{key:0,src:r.avatar_file.url,width:o.width,height:o.height},null,8,["src","width","height"])):(t(),a(d,{key:1,style:n({width:o.width,height:o.height,lineHeight:o.height}),class:"chooseAvatar",type:"plusempty",size:"30",color:"#dddddd"},null,8,["style"]))])),_:1},8,["onChooseavatar","onClick","class","style"])}],["__scopeId","data-v-4cd0367b"]]);i.database().collection("uni-id-users");const F=i.importObject("uni-id-co");const U=e({emits:["success"],computed:{},data:()=>({}),methods:{beforeGetphonenumber:async()=>await new Promise(((e,t)=>{h({mask:!0}),wx.checkSession({success(){e(),p()},fail(){_({success({code:a}){i.importObject("uni-id-co",{customUI:!0}).loginByWeixin({code:a}).then((i=>{e()})).catch((e=>{console.log(e),t()})).finally((e=>{p()}))},fail:e=>{console.error(e),t()}})}})})),async bindMobileByMpWeixin(e){"getPhoneNumber:ok"==e.detail.errMsg?(await this.beforeGetphonenumber(),F.bindMobileByMpWeixin(e.detail).then((e=>{this.$emit("success")})).finally((e=>{this.closeMe()}))):this.closeMe()},async open(){this.$refs.popup.open()},closeMe(e){this.$refs.popup.close()}}},[["render",function(e,i,n,o,l,r){const u=x,d=k,h=c,p=g(y("uni-popup"),v);return t(),a(p,{ref:"popup",type:"bottom"},{default:s((()=>[I(h,{class:"box"},{default:s((()=>[I(u,{class:"headBox"},{default:s((()=>[C("绑定资料")])),_:1}),I(u,{class:"tip"},{default:s((()=>[C("将一键获取你的手机号码绑定你的个人资料")])),_:1}),I(h,{class:"btnBox"},{default:s((()=>[I(u,{onClick:r.closeMe,class:"close"},{default:s((()=>[C("关闭")])),_:1},8,["onClick"]),I(d,{class:"agree uni-btn",type:"primary","open-type":"getPhoneNumber",onGetphonenumber:r.bindMobileByMpWeixin},{default:s((()=>[C("获取")])),_:1},8,["onGetphonenumber"])])),_:1})])),_:1})])),_:1},512)}],["__scopeId","data-v-1edc5089"]]),j=i.importObject("uni-id-co");const $=e({computed:{userInfo:()=>u.userInfo,realNameStatus(){return this.userInfo.realNameAuth?this.userInfo.realNameAuth.authStatus:0}},data:()=>({univerifyStyle:{authButton:{title:"本机号码一键绑定"},otherLoginButton:{title:"其他号码绑定"}},hasPwd:!1,showLoginManage:!1,setNicknameIng:!1}),async onShow(){this.univerifyStyle.authButton.title="本机号码一键绑定",this.univerifyStyle.otherLoginButton.title="其他号码绑定"},async onLoad(e){e.showLoginManage&&(this.showLoginManage=!0);let i=await j.getAccountInfo();this.hasPwd=i.isPasswordSet},methods:{login(){m({url:"/uni_modules/uni-id-pages/pages/login/login-withoutpwd",complete:e=>{}})},logout(){d.logout()},bindMobileSuccess(){d.updateUserInfo()},changePassword(){m({url:"/uni_modules/uni-id-pages/pages/userinfo/change_pwd/change_pwd",complete:e=>{}})},bindMobile(){this.bindMobileBySmsCode()},univerify(){_({provider:"univerify",univerifyStyle:this.univerifyStyle,success:async e=>{j.bindMobileByUniverify(e.authResult).then((e=>{d.updateUserInfo()})).catch((e=>{console.log(e)})).finally((e=>{uni.closeAuthView()}))},fail:e=>{console.log(e),"30002"!=e.code&&"30001"!=e.code||this.bindMobileBySmsCode()}})},bindMobileBySmsCode(){m({url:"./bind-mobile/bind-mobile"})},setNickname(e){e?(d.updateUserInfo({nickname:e}),this.setNicknameIng=!1,this.$refs.dialog.close()):this.$refs.dialog.open()},deactivate(){m({url:"/uni_modules/uni-id-pages/pages/userinfo/deactivate/deactivate"})},async bindThirdAccount(e){const t=i.importObject("uni-id-co"),a={weixin:"wx_openid",alipay:"ali_openid",apple:"apple_openid",qq:"qq_openid"}[e.toLowerCase()];this.userInfo[a]?(await t["unbind"+e](),await d.updateUserInfo()):_({provider:e.toLowerCase(),onlyAuthorize:!0,success:async i=>{const a=await t["bind"+e]({code:i.code});a.errCode&&S({title:a.errMsg||"绑定失败",duration:3e3}),await d.updateUserInfo()},fail:async e=>{console.log(e),p()}})},realNameVerify(){m({url:"/uni_modules/uni-id-pages/pages/userinfo/realname-verify/realname-verify"})}}},[["render",function(e,i,n,l,r,u){const d=g(y("uni-id-pages-avatar"),T),h=c,p=g(y("uni-list-item"),B),m=g(y("uni-list"),L),f=g(y("uni-popup-dialog"),A),b=g(y("uni-popup"),v),w=g(y("uni-id-pages-bind-mobile"),U),_=k;return t(),a(h,{class:"uni-content"},{default:s((()=>[I(h,{class:"avatar"},{default:s((()=>[I(d,{width:"260rpx",height:"260rpx"})])),_:1}),I(m,null,{default:s((()=>[I(p,{class:"item",onClick:i[0]||(i[0]=e=>u.setNickname("")),title:"昵称",rightText:u.userInfo.nickname||"未设置",link:""},null,8,["rightText"]),I(p,{class:"item",onClick:u.bindMobile,title:"手机号",rightText:u.userInfo.mobile||"未绑定",link:""},null,8,["onClick","rightText"]),u.userInfo.email?(t(),a(p,{key:0,class:"item",title:"电子邮箱",rightText:u.userInfo.email},null,8,["rightText"])):o("",!0),r.hasPwd?(t(),a(p,{key:1,class:"item",onClick:u.changePassword,title:"修改密码",link:""},null,8,["onClick"])):o("",!0)])),_:1}),I(m,{class:"mt10"},{default:s((()=>[I(p,{onClick:u.deactivate,title:"注销账号",link:"navigateTo"},null,8,["onClick"])])),_:1}),I(b,{ref:"dialog",type:"dialog"},{default:s((()=>[I(f,{mode:"input",value:u.userInfo.nickname,onConfirm:u.setNickname,inputType:r.setNicknameIng?"nickname":"text",title:"设置昵称",placeholder:"请输入要设置的昵称"},null,8,["value","onConfirm","inputType"])])),_:1},512),I(w,{ref:"bind-mobile-by-sms",onSuccess:u.bindMobileSuccess},null,8,["onSuccess"]),r.showLoginManage?(t(),M(P,{key:0},[u.userInfo._id?(t(),a(_,{key:0,onClick:u.logout},{default:s((()=>[C("退出登录")])),_:1},8,["onClick"])):(t(),a(_,{key:1,onClick:u.login},{default:s((()=>[C("去登录")])),_:1},8,["onClick"]))],64)):o("",!0)])),_:1})}],["__scopeId","data-v-a98497c8"]]);export{$ as default};
