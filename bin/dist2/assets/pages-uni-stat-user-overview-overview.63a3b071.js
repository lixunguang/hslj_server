import{_ as t,D as e,n as a,o as s,c as r,w as i,i as o,a as l,z as n,b as d,d as u,f as c,g as p,aD as m}from"./index-eb11052f.js";import{_ as h}from"./uni-stat-breadcrumb.d2425bd8.js";import{_}from"./uni-data-select.d15808f8.js";import{_ as f}from"./uni-stat-tabs.d6ba3861.js";import{_ as g}from"./uni-stat-panel.063e6fc0.js";import{_ as b}from"./qiun-data-charts.35b2653d.js";import{s as y,d as D,g as v,a as q,b as x,p as T,m as C,c as w,h as F}from"./util.12e31f50.js";import"./uni-tooltip.bce57969.js";const V=[{value:"今天",contrast:"昨天"},{title:"新增用户",field:"new_user_count",tooltip:"首次访问应用的用户数（以用户为判断标准，去重）",value:0,contrast:0},{title:"活跃用户",field:"active_user_count",tooltip:"访问过应用内任意页面的总用户数，今日数据为每小时活跃用户累加（未虑重），昨日数据为全天活跃用户虑重后结果。",value:0,contrast:0},{title:"次均停留时长",field:"avg_user_session_time",formatter:":",tooltip:"平均每次打开应用停留在应用内的总时长，即应用停留总时长/启动次数",value:0,contrast:0,stat:"avg"},{title:"人均停留时长 ",field:"avg_user_time",formatter:":",tooltip:"平均每个用户停留在应用内的总时长，即应用停留总时长/活跃用户",value:0,contrast:0,stat:"avg"},{title:"总用户数",field:"total_users",tooltip:"从添加统计到当前选择时间的总用户数（去重）",value:0,contrast:0}],S=[{title:"受访页",field:"path",tooltip:"用户进入应用访问的所有页面，例如用户从页面1进入应用，跳转到页面2，1,2均为受访页",formatter:""},{title:"访问次数",field:"visit_times",tooltip:"访问该页面的总次数",value:0},{title:"占比",field:"rate",computed:"visit_times/total_app_access",tooltip:"某个页面的访问次数占所有页面访问次数的比例",formatter:"%"}],I=[{title:"入口页",field:"path",tooltip:"用户进入应用访问的第一个页面，例如用户从页面1进入应用，跳转到页面2，1为入口页，而2不是",formatter:""},{title:"访问次数",field:"entry_count",tooltip:"访问该页面的总次数",value:0},{title:"占比",field:"rate",computed:"entry_count/total_app_access",tooltip:"某个页面的访问次数占所有页面访问次数的比例",formatter:"%"}],N=V.filter((t=>t.hasOwnProperty("value")));const M=t({data:()=>({tableName:"uni-stat-result",fieldsMap:V,resFieldsMap:S,entFieldsMap:I,query:{dimension:"hour",appid:"",platform_id:"",uni_platform:"",version_id:"",start_time:[]},options:{pageCurrent:1,total:0,pageSizeIndex:0,pageSizeRange:[10,20,50,100]},loading:!1,currentDateTab:2,chartTab:"new_user_count",tableData:[],resTableData:[],entTableData:[],panelData:N,chartData:{},eopts:{seriesTemplate:[{itemStyle:{borderWidth:2,borderColor:"#1890FF",color:"#1890FF"},areaStyle:{color:{colorStops:[{offset:0,color:"#1890FF"},{offset:1,color:"#FFFFFF"}]}}},{lineStyle:{color:"#ea7ccc",width:2,type:"dashed"},itemStyle:{borderWidth:1,borderColor:"#ea7ccc",color:"#ea7ccc"},areaStyle:null}]},tabIndex:0,errorMessage:""}),onLoad(t){const{appid:e}=t;e&&(this.query.appid=e)},computed:{pageSize(){const{pageSizeRange:t,pageSizeIndex:e}=this.options;return t[e]},chartTabs(){const t=[];return V.forEach((e=>{const a=e.field,s=e.title;a&&s&&t.push({_id:a,name:s})})),t},versionQuery(){const{appid:t,uni_platform:e}=this.query;return y({appid:t,uni_platform:e})},channelQuery(){const{appid:t,platform_id:e}=this.query;return y({appid:t,platform_id:e})}},created(){this.debounceGet=D((()=>{this.getAllData(this.query)}),300)},watch:{query:{deep:!0,handler(t){this.options.pageCurrent=1,this.debounceGet()}}},methods:{useDatetimePicker(){this.currentDateTab=null},changePlatform(t,e,a,s){this.query.version_id=0,this.query.uni_platform=s.code},changeTimeRange(t,e){this.currentDateTab=e;let a,s;a=v(t),s=t?v(0)-1:v(0)+864e5-1,this.query.start_time=[a,s]},changePageCurrent(t){this.options.pageCurrent=t.current,this.getChartData(this.query)},changePageSize(t){const{value:e}=t.detail;this.options.pageCurrent=1,this.options.pageSizeIndex=e,this.getChartData(this.query)},changeChartTab(t,e,a){this.tabIndex=e,this.getChartData(this.query,t,a)},getAllData(t){t.appid?(this.errorMessage="",this.getPanelData(),this.getChartData(t)):this.errorMessage="请先选择应用"},getDays(){if(!this.query.start_time.length)return!0;const[t,e]=this.query.start_time;return e-t>=864e5},getPanelData(){const{appid:t,platform_id:a,version_id:s}=this.query,r=y({appid:t,platform_id:a,version_id:s,start_time:[v(1),(new Date).getTime()]});e.database().collection(this.tableName).where(r).field(`${q(V)},dimension,stat_date`).groupBy("stat_date, dimension").groupField(x(V)).orderBy("stat_date","desc").get().then((t=>{const e=t.result.data,a=e.find((t=>t.stat_date===T(v(0),"","")))||{};a.total_users=0;const s=e.find((t=>"day"===t.dimension&&t.stat_date===T(v(1),"","")));this.panelData=[],this.panelData=C(V,a),this.panelData.map((t=>{C(V,s,t,"","contrast")})),w.call(this,r,"total_users")}))},getChartData(t,a=this.chartTabs[this.tabIndex]._id,s=this.chartTabs[this.tabIndex].name){this.options;const r=this.currentDateTab,i=v(r),o=864e5;let l;if(!this.getDays()){const e=i-o,a=i+o-1;t=JSON.parse(JSON.stringify(t)),l=t.start_time=[e,a]}t=y(t,!0,["uni_platform"]);e.database().collection(this.tableName).where(t).field(`${q(V,a)}, start_time`).groupBy("start_time").groupField(x(V,a)).orderBy("start_time","asc").get({getCount:!0}).then((t=>{const{count:e,data:r}=t.result,o={categories:[],series:[{name:s,data:[]}]};let n=V.filter((t=>t.field===a));if(n=JSON.parse(JSON.stringify(n)),delete n[0].value,n[0].formatter="",this.getDays())for(const s of r){C(n,s,s);const t=F(s.start_time,"day");let e=Number(s[a]);o.series[0].data.push(e),o.categories.push(t)}else{const[t,e]=l,s=o.series[1]={name:F(t),data:[]},d=o.series[0]={name:F(e),data:[]};for(let l=0;l<24;++l){const t=l<10?"0"+l:l,e=`${t}:00 ~ ${t}:59`;o.categories.push(e),s.data[l]=0,d.data[l]=0,r.forEach((t=>{C(n,t,t);let e=Number(t[a]);const r=new Date(t.start_time);t.start_time<i?r.getHours()===l&&(s.data[l]=e):r.getHours()===l&&(d.data[l]=e)}))}}this.chartData=o})).catch((t=>{console.error(t)})).finally((()=>{}))},getAppAccessTimes(t){return e.database().collection(this.tableName).where(t).groupBy("appid").groupField("sum(page_visit_count) as total_app_access").get()},navTo(t){t&&a({url:t})}}},[["render",function(t,e,a,y,D,v){const q=c(p("uni-stat-breadcrumb"),h),x=o,T=c(p("uni-data-select"),_),C=c(p("uni-stat-tabs"),f),w=c(p("uni-datetime-picker"),m),F=c(p("uni-stat-panel"),g),V=c(p("qiun-data-charts"),b);return s(),r(x,{class:"fix-top-window"},{default:i((()=>[l(x,{class:"uni-header"},{default:i((()=>[l(q,{class:"uni-stat-breadcrumb-on-phone"})])),_:1}),l(x,{class:"uni-container"},{default:i((()=>[l(x,{class:"uni-stat--x flex p-1015"},{default:i((()=>[l(T,{collection:"opendb-app-list",field:"appid as value, name as text",orderby:"text asc",defItem:1,label:"应用选择",modelValue:D.query.appid,"onUpdate:modelValue":e[0]||(e[0]=t=>D.query.appid=t),clear:!1},null,8,["modelValue"]),l(T,{collection:"opendb-app-versions",where:v.versionQuery,class:"ml-m",field:"_id as value, version as text, uni_platform as label, create_date as date",format:"{label} - {text}",orderby:"date desc",label:"版本选择",modelValue:D.query.version_id,"onUpdate:modelValue":e[1]||(e[1]=t=>D.query.version_id=t)},null,8,["where","modelValue"])])),_:1}),l(x,{class:"uni-stat--x flex"},{default:i((()=>[l(C,{label:"日期选择",current:D.currentDateTab,mode:"date",today:!0,onChange:v.changeTimeRange},null,8,["current","onChange"]),l(w,{type:"datetimerange",end:(new Date).getTime(),modelValue:D.query.start_time,"onUpdate:modelValue":e[2]||(e[2]=t=>D.query.start_time=t),returnType:"timestamp",clearIcon:!1,class:n(["uni-stat-datetime-picker",{"uni-stat__actived":D.currentDateTab<0&&!!D.query.start_time.length}]),onChange:v.useDatetimePicker},null,8,["end","modelValue","class","onChange"])])),_:1}),l(x,{class:"uni-stat--x"},{default:i((()=>[l(C,{label:"平台选择",type:"boldLine",mode:"platform",modelValue:D.query.platform_id,"onUpdate:modelValue":e[3]||(e[3]=t=>D.query.platform_id=t),onChange:v.changePlatform},null,8,["modelValue","onChange"]),D.query.platform_id&&-1===D.query.platform_id.indexOf("==")?(s(),r(T,{key:0,ref:"version-select",collection:"uni-stat-app-channels",where:v.channelQuery,class:"p-channel",field:"_id as value, channel_name as text",orderby:"text asc",label:"渠道/场景值选择",modelValue:D.query.channel_id,"onUpdate:modelValue":e[4]||(e[4]=t=>D.query.channel_id=t)},null,8,["where","modelValue"])):d("",!0)])),_:1}),l(F,{items:D.panelData,contrast:!0},null,8,["items"]),l(x,{class:"uni-stat--x p-m"},{default:i((()=>[l(x,{class:"uni-stat-card-header"},{default:i((()=>[u(" 趋势图 ")])),_:1}),l(C,{type:"box",modelValue:D.chartTab,"onUpdate:modelValue":e[5]||(e[5]=t=>D.chartTab=t),tabs:v.chartTabs,class:"mb-l",onChange:v.changeChartTab},null,8,["modelValue","tabs","onChange"]),l(x,{class:"uni-charts-box"},{default:i((()=>[l(V,{type:"area",chartData:D.chartData,eopts:D.eopts,echartsH5:"",echartsApp:"",tooltipFormat:"tooltipCustom",errorMessage:D.errorMessage},null,8,["chartData","eopts","errorMessage"])])),_:1})])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-ff870bad"]]);export{M as default};
