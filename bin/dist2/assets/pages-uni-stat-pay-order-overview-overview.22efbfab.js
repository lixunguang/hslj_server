import{_ as t}from"./uni-stat-breadcrumb.d2425bd8.js";import{_ as e,D as a,o as n,c as l,w as i,a as s,d as r,e as d,r as o,F as u,i as m,f as c,g as _,am as f,t as p,h,j as y,A as g,k as b,l as D,aD as C,b as x,B as T}from"./index-eb11052f.js";import{_ as q}from"./uni-data-select.d15808f8.js";import{_ as v}from"./uni-stat-tabs.d6ba3861.js";import{d as $,s as w,a as M,b as k,l as A,g as O,p as V,n as E}from"./util.12e31f50.js";import{_ as S}from"./uni-tooltip.bce57969.js";import{t as j}from"./timeUtil.4078d62f.js";import{_ as F}from"./qiun-data-charts.35b2653d.js";const P=[{title:"订单金额",group:"total_amount",list:[{title:"下单金额",field:"create_total_amount",tooltip:"下单：统计时间内，下单金额（包含未支付订单和退款订单）。",formatter:",",value:"-",contrast:0,stat:"sum",fix:2,trendChart:!0,multiple:.01},{title:"收款金额",field:"pay_total_amount",tooltip:"收款：统计时间内，成功支付的订单金额（包含退款订单）。",formatter:",",value:"-",contrast:0,stat:"sum",fix:2,trendChart:!0,multiple:.01},{title:"退款金额",field:"refund_total_amount",tooltip:"退款：统计时间内，发生退款的金额。",formatter:",",value:"-",contrast:0,stat:"sum",fix:2,multiple:.01}]},{title:"订单数量",group:"order_count",list:[{title:"下单数量",field:"create_order_count",tooltip:"下单：统计时间内，成功下单的订单笔数（包含未支付订单和退款订单）。",formatter:",",value:"-",contrast:0,stat:"sum",fix:0,trendChart:!0},{title:"收款数量",field:"pay_order_count",tooltip:"收款：统计时间内，成功支付的订单数（包含退款订单）。",formatter:"",value:"-",contrast:0,stat:"sum",fix:0,trendChart:!0},{title:"退款数量",field:"refund_order_count",tooltip:"退款：统计时间内，发生退款的订单数。",formatter:"",value:"-",contrast:0,stat:"sum",fix:0}]},{title:"用户数量",group:"user_count",list:[{title:"下单用户数",field:"create_user_count",tooltip:"下单：统计时间内，成功下单的客户数（包含未支付订单和退款订单）。",formatter:",",value:"-",contrast:0,stat:"sum",fix:0,trendChart:!0},{title:"收款用户数",field:"pay_user_count",tooltip:"收款：统计时间内，成功支付的用户数（包含退款订单）。",formatter:",",value:"-",contrast:0,stat:"sum",fix:0,trendChart:!0},{title:"退款用户数",field:"refund_user_count",tooltip:"退款：统计时间内，发生退款的用户数。",formatter:",",value:"-",contrast:0,stat:"sum",fix:0}]},{title:"设备数量",group:"device_count",list:[{title:"下单设备数",field:"create_device_count",tooltip:"下单：统计时间内，成功下单的设备数（包含未支付订单和退款订单）。",formatter:",",value:"-",contrast:0,stat:"sum",fix:0,trendChart:!0},{title:"收款设备数",field:"pay_device_count",tooltip:"收款：统计时间内，成功支付的设备数（包含退款订单）。",formatter:",",value:"-",contrast:0,stat:"sum",fix:0,trendChart:!0},{title:"退款设备数",field:"refund_device_count",tooltip:"退款：统计时间内，发生退款的设备数。",formatter:",",value:"-",contrast:0,stat:"sum",fix:0}]}];let B=[];P.map(((t,e)=>{t.list.map(((t,e)=>{B.push(t)}))}));let N=[{title:"下单金额（GMV）",field:"create_total_amount",tooltip:"统计时间内，下单金额（包含未支付订单和退款订单）。",formatter:",",value:"-",contrast:0,stat:"sum",fix:2,trendChart:!0,multiple:.01},{title:"收款金额（GPV）",field:"pay_total_amount",tooltip:"统计时间内，成功支付的订单金额（包含退款订单）。",formatter:",",value:"-",contrast:0,stat:"sum",fix:2,trendChart:!0,multiple:.01},{title:"退款金额",field:"refund_total_amount",tooltip:"统计时间内，发生退款的金额。",formatter:",",value:"-",contrast:0,stat:"sum",fix:2,trendChart:!0,multiple:.01},{title:"实收金额",field:"actual_total_amount",tooltip:"实收金额=收款金额-退款金额",formatter:",",value:"-",contrast:0,stat:"sum",fix:2,trendChart:!0,multiple:.01}];const U=e({props:{query:{type:[Object],default:function(){return{}}}},data:()=>({tableName:"uni-stat-pay-result",fieldsMap:N,panelData:{today:{pay_total_amount:"-",pay_order_count:"-"},yesterday:{pay_total_amount:"-",pay_order_count:"-"},beforeyesterday:{pay_total_amount:"-",pay_order_count:"-"},week:{pay_total_amount:"-",pay_order_count:"-"},month:{pay_total_amount:"-",pay_order_count:"-"},quarter:{pay_total_amount:"-",pay_order_count:"-"},year:{pay_total_amount:"-",pay_order_count:"-"},total:{pay_total_amount:"-",pay_order_count:"-"}},loading:!1}),created(){this.getCloudDataDebounce=$((()=>{this.getCloudData()}),300),this.getCloudDataDebounce()},methods:{getCloudData(){let t=this.query;if(!t.appid)return;this.loading=!0,t=w(t,!0,["uni_platform"]);let e=this.getWhere(t);t&&(e=`${t} && (${e})`);const n=a.database();n.collection(this.tableName).where(e).field(`${M(N)}, dimension, stat_date.date_str as stat_time, start_time`).groupBy("stat_time, dimension").groupField(k(N)+",last(start_time) as start_time").get().then((t=>{let e=t.result.data;e.map(((t,e)=>{t.actual_total_amount||(t.actual_total_amount=t.pay_total_amount-t.refund_total_amount)})),e=A({fieldsMap:N,data:e}),this.loading=!1,Object.assign(this.panelData,this.setPanelData(e))}));let l=`${t} && dimension == "year"`;n.collection(this.tableName).where(l).field(`${M(N)}, dimension`).groupBy("dimension").groupField(k(N)).get().then((t=>{let e=t.result.data;e.map(((t,e)=>{t.actual_total_amount=t.pay_total_amount-t.refund_total_amount})),e=A({fieldsMap:N,data:e}),Object.assign(this.panelData,{total:e[0]||{pay_total_amount:0,pay_order_count:0,create_total_amount:0,refund_total_amount:0,actual_total_amount:0}})}))},getWhere(t){let e,a=Date.now(),n=j.getOffsetStartAndEnd("day",0,a),l=j.getOffsetStartAndEnd("day",-1,a),i=j.getOffsetStartAndEnd("day",-2,a),s=j.getOffsetStartAndEnd("week",0,a),r=j.getOffsetStartAndEnd("month",0,a),d=j.getOffsetStartAndEnd("quarter",0,a),o=j.getOffsetStartAndEnd("year",0,a);return e=`(dimension=="day" && start_time==${n.startTime} && end_time==${n.endTime}) || (dimension=="day" && start_time==${l.startTime} && end_time==${l.endTime}) || (dimension=="day" && start_time==${i.startTime} && end_time==${i.endTime}) || (dimension=="week" && start_time==${s.startTime} && end_time==${s.endTime}) || (dimension=="month" && start_time==${r.startTime} && end_time==${r.endTime}) || (dimension=="quarter" && start_time==${d.startTime} && end_time==${d.endTime}) || (dimension=="year" && start_time==${o.startTime} && end_time==${o.endTime})`,e},setPanelData(t){let e=Date.now(),a=j.getOffsetStartAndEnd("day",0,e),n=j.getOffsetStartAndEnd("day",-1,e),l=j.getOffsetStartAndEnd("day",-2,e),i={pay_total_amount:0,pay_order_count:0,create_total_amount:0,refund_total_amount:0,actual_total_amount:0};return{today:t.find((t=>"day"===t.dimension&&t.start_time===a.startTime))||i,yesterday:t.find((t=>"day"===t.dimension&&t.start_time===n.startTime))||i,beforeyesterday:t.find((t=>"day"===t.dimension&&t.start_time===l.startTime))||i,week:t.find((t=>"week"===t.dimension))||i,month:t.find((t=>"month"===t.dimension))||i,quarter:t.find((t=>"quarter"===t.dimension))||i,year:t.find((t=>"year"===t.dimension))||i}}},watch:{query:{deep:!0,handler(t){this.getCloudDataDebounce()}}}},[["render",function(t,e,a,C,x,T){const q=m,v=c(_("uni-th"),h),$=c(_("uni-tr"),y),w=c(_("uni-icons"),g),M=c(_("uni-tooltip"),S),k=c(_("uni-td"),b),A=c(_("uni-table"),D);return n(),l(q,{class:"uni-stat--x p-m"},{default:i((()=>[s(q,{class:"uni-stat-card-header"},{default:i((()=>[r("概况")])),_:1}),s(A,{loading:x.loading,border:"",stripe:"",emptyText:"暂无更多数据",style:{"min-height":"100px"}},{default:i((()=>[s($,null,{default:i((()=>[s(v,{align:"center",class:"th"}),s(v,{align:"center",class:"th"},{default:i((()=>[r("今日")])),_:1}),s(v,{align:"center",class:"th"},{default:i((()=>[r("昨日")])),_:1}),s(v,{align:"center",class:"th"},{default:i((()=>[r("前日")])),_:1}),s(v,{align:"center",class:"th"},{default:i((()=>[r("本周")])),_:1}),s(v,{align:"center",class:"th"},{default:i((()=>[r("本月")])),_:1}),s(v,{align:"center",class:"th"},{default:i((()=>[r("本季度")])),_:1}),s(v,{align:"center",class:"th"},{default:i((()=>[r("本年度")])),_:1}),s(v,{align:"center",class:"th"},{default:i((()=>[r("累计")])),_:1})])),_:1}),(n(!0),d(u,null,o(x.fieldsMap,((t,e)=>(n(),l($,{key:e},{default:i((()=>[s(k,{align:"center",class:"td"},{default:i((()=>[s(M,null,f({default:i((()=>[s(q,{class:"uni-stat--sum-item-title"},{default:i((()=>[r(p(t.title)+" ",1),s(w,{class:"ml-s",type:"help",color:"#666"})])),_:2},1024)])),_:2},[t.tooltip?{name:"content",fn:i((()=>[s(q,{class:"uni-stat-tooltip-s"},{default:i((()=>[r(p(t.tooltip),1)])),_:2},1024)])),key:"0"}:void 0]),1024)])),_:2},1024),s(k,{align:"center",class:"td"},{default:i((()=>[r(p(x.panelData.today[t.field]),1)])),_:2},1024),s(k,{align:"center",class:"td"},{default:i((()=>[r(p(x.panelData.yesterday[t.field]),1)])),_:2},1024),s(k,{align:"center",class:"td"},{default:i((()=>[r(p(x.panelData.beforeyesterday[t.field]),1)])),_:2},1024),s(k,{align:"center",class:"td"},{default:i((()=>[r(p(x.panelData.week[t.field]),1)])),_:2},1024),s(k,{align:"center",class:"td"},{default:i((()=>[r(p(x.panelData.month[t.field]),1)])),_:2},1024),s(k,{align:"center",class:"td"},{default:i((()=>[r(p(x.panelData.quarter[t.field]),1)])),_:2},1024),s(k,{align:"center",class:"td"},{default:i((()=>[r(p(x.panelData.year[t.field]),1)])),_:2},1024),s(k,{align:"center",class:"td"},{default:i((()=>[r(p(x.panelData.total[t.field]),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1},8,["loading"])])),_:1})}],["__scopeId","data-v-9f2e867a"]]);const L=e({props:{query:{type:[Object],default:function(){return{}}}},data:()=>({tableName:"uni-stat-pay-result",panelData:P,loading:!1}),created(){this.getCloudDataDebounce=$((()=>{this.getCloudData()}),300),this.getCloudDataDebounce()},methods:{getCloudData(){let t=this.query;if(!t.appid)return;this.loading=!0;const e=w({...t,start_time:[O(0),Date.now()]},!0,["uni_platform"]);a.database().collection(this.tableName).where(e).field(`${M(B)}, dimension, stat_date.date_str as stat_time, start_time`).groupBy("stat_time, dimension").groupField(k(B)).orderBy("stat_time","desc").get().then((t=>{let e=t.result.data;e=A({fieldsMap:B,data:e});let a=e.find((t=>"day"===t.dimension&&t.stat_time===V(O(0),"")));a||(a=e.find((t=>"hour"===t.dimension&&t.stat_time===V(O(0),"")))||{}),this.loading=!1,this.panelData=this.setPanelData(a)}))},setPanelData(t){let e=this.panelData;return e.map(((e,a)=>{e.list.map(((e,a)=>{e.value=t[e.field]||0}))})),e}},watch:{query:{deep:!0,handler(t){this.getCloudDataDebounce()}}}},[["render",function(t,e,a,f,C,x){const T=m,q=c(_("uni-th"),h),v=c(_("uni-icons"),g),$=c(_("uni-tooltip"),S),w=c(_("uni-tr"),y),M=c(_("uni-td"),b),k=c(_("uni-table"),D);return n(),l(T,{class:"uni-stat--x p-m"},{default:i((()=>[s(T,{class:"uni-stat-card-header"},{default:i((()=>[r("今日数据")])),_:1}),s(k,{loading:C.loading,border:"",stripe:"",emptyText:"暂无更多数据",style:{"min-height":"100px"}},{default:i((()=>[s(w,null,{default:i((()=>[s(q,{align:"center",class:"th"}),(n(!0),d(u,null,o(C.panelData,((t,e)=>(n(),l(q,{align:"center",class:"th",key:e},{default:i((()=>[s($,null,{content:i((()=>[s(T,{class:"uni-stat-tooltip-s"},{default:i((()=>[(n(!0),d(u,null,o(t.list,((t,e)=>(n(),l(T,{key:e},{default:i((()=>[r(p(t.tooltip),1)])),_:2},1024)))),128))])),_:2},1024)])),default:i((()=>[s(T,{class:"uni-stat--sum-item-title"},{default:i((()=>[r(p(t.title)+" ",1),s(v,{class:"ml-s",type:"help",color:"#666"})])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:1}),s(w,null,{default:i((()=>[s(M,{align:"center",class:"td"},{default:i((()=>[r("下单")])),_:1}),(n(!0),d(u,null,o(C.panelData,((t,e)=>(n(),l(M,{align:"center",class:"td",key:e},{default:i((()=>[r(p(t.list[0].value),1)])),_:2},1024)))),128))])),_:1}),s(w,null,{default:i((()=>[s(M,{align:"center",class:"td"},{default:i((()=>[r("收款")])),_:1}),(n(!0),d(u,null,o(C.panelData,((t,e)=>(n(),l(M,{align:"center",class:"td",key:e},{default:i((()=>[r(p(t.list[1].value),1)])),_:2},1024)))),128))])),_:1}),s(w,null,{default:i((()=>[s(M,{align:"center",class:"td"},{default:i((()=>[r("退款")])),_:1}),(n(!0),d(u,null,o(C.panelData,((t,e)=>(n(),l(M,{align:"center",class:"td",key:e},{default:i((()=>[r(p(t.list[2].value),1)])),_:2},1024)))),128))])),_:1})])),_:1},8,["loading"])])),_:1})}],["__scopeId","data-v-2f62b91c"]]);let Q=[];P.forEach((t=>{const e=t.group,a=t.title;e&&a&&Q.push({_id:e,name:a,list:t.list})}));const G=e({components:{statPanelTotal:U,statPanelToday:L,trendChart:e({props:{query:{type:[Object],default:function(){return{}}}},data:()=>({tableName:"uni-stat-pay-result",chartData:{},errorMessage:"",opts:{color:["#1890FF","#91CB74","#FAC858","#EE6666","#73C0DE","#3CA272","#FC8452","#9A60B4","#ea7ccc"],padding:[15,15,0,15],legend:{},enableScroll:!0,dataLabel:!1,xAxis:{disableGrid:!0,itemCount:24,fontSize:12,boundaryGap:"center"},yAxis:{gridType:"dash",dashLength:2,data:[{tofix:2}]},extra:{area:{type:"straight",opacity:.2,addLine:!0,width:2,gradient:!1}},legend:{position:"bottom"}},dateTabs:{time:[],timeStr:"",index:2,list:[{_id:1,name:"昨天",dimension:"hour"},{_id:0,name:"今天",dimension:"hour"},{_id:7,name:"最近七天",dimension:"day"},{_id:30,name:"最近30天",dimension:"day"},{_id:90,name:"最近90天",dimension:"day"},{_id:372,name:"月纬度",dimension:"month"},{_id:1116,name:"季纬度",dimension:"quarter"},{_id:4392,name:"年纬度",dimension:"year"}]},statTabs:{index:0,list:Q},queryMode:0}),created(){this.getCloudDataDebounce=$((()=>{this.getCloudData()}),300),this.getCloudDataDebounce()},methods:{getCloudData(t={}){let e=this.query;if(!e.appid)return void(this.errorMessage="请先选择应用");this.errorMessage="";let n=this.getWhere(),l={...e,...n},i=this.statTabs.list[this.statTabs.index].list;l=w(l,!0,["uni_platform"]);a.database().collection(this.tableName).where(l).field(`${M(i)}, start_time`).groupBy("start_time").groupField(k(i)).orderBy("start_time","asc").limit(100).get({getCount:!0}).then((t=>{let{count:e,data:a}=t.result;a=E(a,n,i),a=A({fieldsMap:i,data:a,formatter:!1}),this.setChartData(a,i,n)})).catch((t=>{console.error(t)})).finally((()=>{}))},setChartData(t,e,a){let n={categories:[],series:[]};e.map(((t,e)=>{t.trendChart&&n.series.push({name:t.title,data:[]})}));for(const l of t){const t=this.formatDate(l.start_time,a.dimension);n.categories.push(t),e.map(((t,e)=>{if(t.trendChart){let a=Number(l[t.field]);n.series[e].data.push(a)}}))}this.chartData=n},formatDate(t,e){let a=new Date(t),n=a.getFullYear(),l=a.getMonth()+1;a.getDate();let i=a.getHours(),s=Math.floor((a.getMonth()+3)/3);return l<10&&(l="0"+l),"hour"===e?`${i}时`:"month"===e?`${n}-${l}`:"quarter"===e?`${n}/Q${s}`:"year"===e?`${n}`:V(a)},datePickerChange(t){this.dateTabs.time=t,this.queryMode=1,this.getCloudData()},dateTabsChange(t,e){this.dateTabs.index=e,this.queryMode=0,this.getCloudData()},statTabsChange(t,e,a){this.statTabs.index=e,this.getCloudData({field:t,name:a})},getWhere(){let t=[],e=this.dateTabs.list[this.dateTabs.index]||{};if("number"==typeof e._id&&0===this.queryMode){let a=O(e._id),n=j.getOffsetStartAndEnd("day",0).endTime;1==e._id&&(n=j.getOffsetStartAndEnd("day",0,a).endTime),t=[a,n]}else this.dateTabs.time&&(t=this.dateTabs.time);let a=e.dimension||"day";return this.dateTabs.timeStr=`${j.timeFormat(t[0])} ~ ${j.timeFormat(t[1])}`,this.dateTabs.time=t,{dimension:a,start_time:t}}},watch:{query:{deep:!0,handler(t){this.getCloudDataDebounce()}}},computed:{}},[["render",function(t,e,a,d,o,u){const f=m,p=c(_("uni-stat-tabs"),v),h=c(_("uni-datetime-picker"),C),y=c(_("qiun-data-charts"),F);return n(),l(f,{class:"uni-stat--x p-m"},{default:i((()=>[s(f,{class:"uni-stat-card-header"},{default:i((()=>[r("趋势图")])),_:1}),s(f,{class:"flex"},{default:i((()=>[s(p,{type:"box",current:o.dateTabs.index,tabs:o.dateTabs.list,onChange:u.dateTabsChange},null,8,["current","tabs","onChange"]),s(h,{type:"datetimerange",modelValue:o.dateTabs.time,"onUpdate:modelValue":e[0]||(e[0]=t=>o.dateTabs.time=t),end:Date.now(),"return-type":"timestamp","clear-icon":!1,class:"uni-stat-datetime-picker",onChange:u.datePickerChange},null,8,["modelValue","end","onChange"])])),_:1}),s(p,{type:"box",current:o.statTabs.index,tabs:o.statTabs.list,onChange:u.statTabsChange},null,8,["current","tabs","onChange"]),s(f,{class:"uni-charts-box"},{default:i((()=>[s(y,{type:"area",chartData:o.chartData,opts:o.opts,errorMessage:o.errorMessage},null,8,["chartData","opts","errorMessage"])])),_:1})])),_:1})}],["__scopeId","data-v-972f220b"]])},data:()=>({query:{appid:"",platform_id:"",uni_platform:"",version_id:"",channel_id:""}}),onLoad(t){const{appid:e}=t;e&&(this.query.appid=e)},computed:{versionQuery(){const{appid:t,uni_platform:e}=this.query;return w({appid:t,uni_platform:e})},channelQuery(){const{appid:t,platform_id:e}=this.query;return w({appid:t,platform_id:e})}},created(){},methods:{platformChange(t,e,a,n){this.query.version_id=0,this.query.uni_platform=n.code}},watch:{}},[["render",function(e,a,r,d,o,u){const f=c(_("uni-stat-breadcrumb"),t),p=m,h=c(_("uni-data-select"),q),y=c(_("uni-stat-tabs"),v),g=T("statPanelTotal"),b=T("statPanelToday"),D=T("trendChart");return n(),l(p,{class:"fix-top-window"},{default:i((()=>[s(p,{class:"uni-header"},{default:i((()=>[s(f,{class:"uni-stat-breadcrumb-on-phone"})])),_:1}),s(p,{class:"uni-container"},{default:i((()=>[s(p,{class:"uni-stat--x flex p-1015"},{default:i((()=>[s(h,{collection:"opendb-app-list",field:"appid as value, name as text",orderby:"text asc",defItem:1,label:"应用选择",modelValue:o.query.appid,"onUpdate:modelValue":a[0]||(a[0]=t=>o.query.appid=t),clear:!1},null,8,["modelValue"]),s(h,{collection:"opendb-app-versions",where:u.versionQuery,class:"ml-m",field:"_id as value, version as text, uni_platform as label, create_date as date",format:"{label} - {text}",orderby:"date desc",label:"版本选择",modelValue:o.query.version_id,"onUpdate:modelValue":a[1]||(a[1]=t=>o.query.version_id=t)},null,8,["where","modelValue"])])),_:1}),s(p,{class:"uni-stat--x"},{default:i((()=>[s(y,{label:"平台选择",type:"boldLine",mode:"platform",modelValue:o.query.platform_id,"onUpdate:modelValue":a[2]||(a[2]=t=>o.query.platform_id=t),onChange:u.platformChange},null,8,["modelValue","onChange"]),o.query.platform_id&&-1===o.query.platform_id.indexOf("==")?(n(),l(h,{key:0,collection:"uni-stat-app-channels",where:u.channelQuery,class:"p-channel",field:"_id as value, channel_name as text",orderby:"text asc",label:"渠道/场景值选择",modelValue:o.query.channel_id,"onUpdate:modelValue":a[3]||(a[3]=t=>o.query.channel_id=t)},null,8,["where","modelValue"])):x("",!0)])),_:1}),s(g,{query:o.query},null,8,["query"]),s(b,{query:o.query},null,8,["query"]),s(D,{query:o.query},null,8,["query"])])),_:1})])),_:1})}]]);export{G as default};
