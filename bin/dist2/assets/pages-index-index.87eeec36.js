import{_ as e,D as t,n as a,o as l,c as i,w as s,i as o,a as d,b as n,d as p,e as u,r,F as c,f,g as h,t as _,h as m,j as v,k as b,l as y}from"./index-eb11052f.js";import{_ as g}from"./uni-stat-breadcrumb.d2425bd8.js";import{_ as k}from"./uni-notice-bar.0229781b.js";import{_ as w}from"./uni-stat-tabs.d6ba3861.js";import{g as T,d as A,s as D,a as x,b as I,p as S,f as q,c as F}from"./util.12e31f50.js";import"./uni-tooltip.bce57969.js";const C=[{value:"今天",contrast:"昨天"},{field:"appid",title:"APPID",tooltip:""},{field:"name",title:"应用名",tooltip:""},{field:"total_devices",title:"总设备数",tooltip:"从添加统计到当前选择时间的总设备数（去重）",value:0,contrast:0},{field:"new_device_count",title:"新增设备",tooltip:"首次访问应用的设备数（以设备为判断标准，去重）",value:0,contrast:0},{field:"active_device_count",title:"活跃设备",tooltip:"访问过应用内任意页面的总设备数（去重）",value:0,contrast:0}],$=[{value:"今天",contrast:"昨天"},{field:"appid",title:"APPID",tooltip:""},{field:"name",title:"应用名",tooltip:""},{field:"total_users",title:"总用户数",tooltip:"从添加统计到当前选择时间的总用户数（去重）",value:0,contrast:0},{field:"new_user_count",title:"新增用户",tooltip:"首次访问应用的用户数（以用户为判断标准，去重）",value:0,contrast:0},{field:"active_user_count",title:"活跃用户",tooltip:"访问过应用内任意页面的总用户数（去重）",value:0,contrast:0}];const O=e({data:()=>({query:{platform_id:"",start_time:[T(1),(new Date).getTime()]},deviceTableData:[],userTableData:[],pageSize:10,pageCurrent:1,total:0,loading:!1,complete:!1,statSetting:{mode:"",day:7},statModeList:[{value:"open",text:"开启"},{value:"close",text:"关闭"},{value:"auto",text:"节能"}],showAddAppId:!1}),onReady(){this.debounceGet=A((()=>{this.getAllData(this.queryStr)}),300),this.debounceGet(),this.checkAppId()},watch:{query:{deep:!0,handler(e){this.debounceGet(this.queryStr)}}},computed:{queryStr(){return D(this.query)+' && (dimension == "hour" || dimension == "day")'},deviceTableFields(){return this.tableFieldsMap(C)},userTableFields(){return this.tableFieldsMap($)}},methods:{getAllData(e){this.getApps(this.queryStr,C,"device"),this.getApps(this.queryStr,$,"user")},tableFieldsMap(e){let t=[];const a=[],l=[],i=[];for(const s of e)if(s.field)if(s.hasOwnProperty("value")){const e=JSON.parse(JSON.stringify(s)),t=JSON.parse(JSON.stringify(s));"total_users"!==s.field&&"total_devices"!==s.field?(e.title="今日"+s.title,e.field=s.field+"_value",t.title="昨日"+s.title,t.field=s.field+"_contrast",a.push(e),l.push(t)):(e.field=s.field+"_value",i.push(e))}else t.push(s);return t=[...t,...a,...l,...i],t},getApps(e,a,l="device"){this.loading=!0;const i=t.database(),s=i.collection("uni-stat-result").where(e).getTemp(),o=i.collection("opendb-app-list").getTemp();i.collection(s,o).field(`${x(a,"","value")},stat_date,appid,dimension`).groupBy("appid,dimension,stat_date").groupField(I(a,"","value")).orderBy("appid","desc").get().then((e=>{let{data:t}=e.result;if(this[`${l}TableData`]=[],!t.length)return;let i=[],s=[],o=[],d=S(T(0),"",""),n=S(T(1),"","");for(const a of t){const{appid:e,name:t}=a.appid&&a.appid[0]||{};a.appid=e,a.name=t,i.indexOf(a.appid)<0&&i.push(a.appid),"hour"===a.dimension&&a.stat_date===d&&s.push(a),"day"===a.dimension&&a.stat_date===n&&o.push(a)}const p=a.map((e=>e.field)).filter(Boolean);for(const a of i){const e={},t=s.find((e=>e.appid===a)),i=o.find((e=>e.appid===a));for(const a of p)if("appid"===a||"name"===a)e[a]=t&&t[a];else{const l=t&&t[a],s=i&&i[a];e[a+"_value"]=q(l),e[a+"_contrast"]=q(s)}if(a&&(e[`total_${l}s_value`]="获取中..."),this[`${l}TableData`].push(e),a){t[`total_${l}s`]=0;const e=JSON.parse(JSON.stringify(this.query));e.start_time=[T(0),(new Date).getTime()],e.appid=a,F.call(this,e,`total_${l}s`).then((e=>{this[`${l}TableData`].find((e=>e.appid===a))[`total_${l}s_value`]=e}))}}})).catch((e=>{console.error(e)})).finally((()=>{this.loading=!1,this.complete=!0}))},navTo(e,t){e.indexOf("http")>-1?window.open(e):(t&&(e=`${e}?appid=${t}`),a({url:e}))},toUrl(e){window.open(e,"_blank")},toAddAppId(){this.showAddAppId=!1,a({url:"/pages/system/app/list",events:{refreshData:()=>{this.checkAppId()}}})},async checkAppId(){const e=t.database();let a=await e.collection("opendb-app-list").count();this.showAddAppId=!a.result||0===a.result.total}}},[["render",function(e,t,a,T,A,D){const x=f(h("uni-stat-breadcrumb"),g),I=o,S=f(h("uni-notice-bar"),k),q=f(h("uni-stat-tabs"),w),F=f(h("uni-th"),m),C=f(h("uni-tr"),v),$=f(h("uni-td"),b),O=f(h("uni-table"),y);return l(),i(I,{class:"fix-top-window"},{default:s((()=>[d(I,{class:"uni-header"},{default:s((()=>[d(x,{class:"uni-stat-breadcrumb-on-phone"}),d(I,{class:"uni-group"},{default:s((()=>[d(I,{class:"uni-sub-title hide-on-phone"})])),_:1})])),_:1}),d(I,{class:"uni-container"},{default:s((()=>[A.showAddAppId?(l(),i(S,{key:0,showGetMore:"",showIcon:"",class:"mb-m pointer",text:"检测到您还未添加应用，点击前往应用管理添加",onClick:D.toAddAppId},null,8,["onClick"])):n("",!0),A.deviceTableData.length||A.userTableData.length||A.query.platform_id||!A.complete?n("",!0):(l(),i(S,{key:1,showGetMore:"",showIcon:"",class:"mb-m pointer",text:"暂无数据, 统计相关功能需开通 uni 统计后才能使用, 如未开通, 点击查看具体流程",onClick:t[0]||(t[0]=e=>D.navTo("https://uniapp.dcloud.io/uni-stat-v2.html"))})),d(I,{class:"uni-stat--x mb-m"},{default:s((()=>[d(q,{label:"平台选择",type:"boldLine",mode:"platform",modelValue:A.query.platform_id,"onUpdate:modelValue":t[1]||(t[1]=e=>A.query.platform_id=e)},null,8,["modelValue"])])),_:1}),d(I,{class:"uni-stat--x p-m"},{default:s((()=>[d(I,{class:"uni-stat-card-header"},{default:s((()=>[p("设备概览")])),_:1}),d(O,{loading:A.loading,border:"",stripe:"",emptyText:"暂无数据"},{default:s((()=>[d(C,null,{default:s((()=>[(l(!0),u(c,null,r(D.deviceTableFields,((e,t)=>(l(),u(c,{key:t},[e.title?(l(),i(F,{key:t,align:"center"},{default:s((()=>[p(_(e.title),1)])),_:2},1024)):n("",!0)],64)))),128))])),_:1}),(l(!0),u(c,null,r(A.deviceTableData,((e,a)=>(l(),i(C,{key:a},{default:s((()=>[(l(!0),u(c,null,r(D.deviceTableFields,((a,o)=>(l(),u(c,{key:o},["appid"===a.field?(l(),i($,{key:0,align:"center"},{default:s((()=>[e.appid?(l(),i(I,{key:0,onClick:t=>D.navTo("/pages/uni-stat/device/overview/overview",e.appid),class:"link-btn-color"},{default:s((()=>[p(_(void 0!==e[a.field]?e[a.field]:"-"),1)])),_:2},1032,["onClick"])):(l(),i(I,{key:1,onClick:t[2]||(t[2]=e=>D.navTo("/pages/system/app/add")),class:"link-btn-color"},{default:s((()=>[p(" 需添加此应用的 appid ")])),_:1}))])),_:2},1024)):(l(),i($,{key:o,align:"center"},{default:s((()=>[p(_(void 0!==e[a.field]?e[a.field]:"-"),1)])),_:2},1024))],64)))),128))])),_:2},1024)))),128))])),_:1},8,["loading"])])),_:1}),d(I,{class:"uni-stat--x p-m"},{default:s((()=>[d(I,{class:"uni-stat-card-header"},{default:s((()=>[p("注册用户概览")])),_:1}),d(O,{loading:A.loading,border:"",stripe:"",emptyText:"暂无数据"},{default:s((()=>[d(C,null,{default:s((()=>[(l(!0),u(c,null,r(D.userTableFields,((e,t)=>(l(),u(c,{key:t},[e.title?(l(),i(F,{key:t,align:"center"},{default:s((()=>[p(_(e.title),1)])),_:2},1024)):n("",!0)],64)))),128))])),_:1}),(l(!0),u(c,null,r(A.userTableData,((e,a)=>(l(),i(C,{key:a},{default:s((()=>[(l(!0),u(c,null,r(D.userTableFields,((a,o)=>(l(),u(c,{key:o},["appid"===a.field?(l(),i($,{key:0,align:"center"},{default:s((()=>[e.appid?(l(),i(I,{key:0,onClick:t=>D.navTo("/pages/uni-stat/user/overview/overview",e.appid),class:"link-btn-color"},{default:s((()=>[p(_(void 0!==e[a.field]?e[a.field]:"-"),1)])),_:2},1032,["onClick"])):(l(),i(I,{key:1,onClick:t[3]||(t[3]=e=>D.navTo("/pages/system/app/add")),class:"link-btn-color"},{default:s((()=>[p(" 需添加此应用的 appid ")])),_:1}))])),_:2},1024)):(l(),i($,{key:o,align:"center"},{default:s((()=>[p(_(void 0!==e[a.field]?e[a.field]:"-"),1)])),_:2},1024))],64)))),128))])),_:2},1024)))),128))])),_:1},8,["loading"])])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-6ee617cc"]]);export{O as default};
