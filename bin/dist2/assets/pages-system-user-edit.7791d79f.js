import{_ as a,D as e,af as t,n as s,N as l,s as o,H as i,y as n,O as r,o as u,c as d,w as m,i as p,a as c,d as f,K as h,t as b,b as g,f as k,g as D,R as _,q as w,X as V}from"./index-eb11052f.js";import{_ as x}from"./uni-easyinput.616bd617.js";import{_ as y}from"./uni-forms-item.08cc8d8e.js";import{_ as A}from"./uni-data-checkbox.2d80fd24.js";import{_ as v}from"./uni-forms.aae0e4e3.js";import{v as C}from"./uni-id-users.cf221585.js";import"./uni-load-more.f734fa78.js";const I=e.database();I.command;function L(a){let e={};for(let t in C)a.includes(t)&&(e[t]=C[t]);return e}const U=a({data:()=>({showPassword:!1,formData:{username:"",nickname:"",password:void 0,role:[],tags:[],authorizedApp:[],mobile:void 0,email:void 0,status:!1},rules:{...L(["username","password","role","mobile","email"]),status:{rules:[{format:"bool"}]}},roles:[],userId:"",appList:[],unknownAppids:[]}),onLoad(a){const e=a.id;this.formDataId=e;let s=t("uni-id-pages-userInfo")||{};this.userId=s._id,this.getDetail(e),this.loadroles()},methods:{gotoAppList(){s({url:"../app/list"})},gotoTagList(){s({url:"../tag/list"})},gotoTagAdd(){s({url:"../tag/add",events:{refreshCheckboxData:()=>{this.$refs.checkboxTags.loadData()}}})},trigger(){this.showPassword=!this.showPassword},submitForm(a){this.$refs.form.submit()},submit(a){const{value:e,errors:t}=a.detail;t||(l({title:"修改中...",mask:!0}),"boolean"==typeof e.status&&(e.status=Number(!e.status)),e.uid=this.formDataId,this.$request("updateUser",e).then((()=>{o({title:"修改成功"});const a=this.getOpenerEventChannel();a.emit&&a.emit("refreshData"),setTimeout((()=>i()),500)})).catch((a=>{n({content:a.message||"请求服务失败",showCancel:!1})})).finally((a=>{r()})))},resetPWd(a){this.$request("system/user/resetPwd",a).then().catch((a=>{n({content:a.message||"请求服务失败",showCancel:!1})})).finally()},getDetail(a){l({mask:!0}),I.collection("uni-id-users").doc(a).field("username,nickname,role,dcloud_appid as authorizedApp,tags,mobile,email,status").get().then((a=>{const e=a.result.data[0];e&&(void 0===e.status&&(e.status=!0),0===e.status&&(e.status=!0),1===e.status&&(e.status=!1),this.formData=Object.assign(this.formData,e),this.loadAppList(this.formData.authorizedApp))})).catch((a=>{n({content:a.message||"请求服务失败",showCancel:!1})})).finally((()=>{r()}))},loadroles(){I.collection("uni-id-roles").limit(500).get().then((a=>{const e=[];this.roles=a.result.data.map((a=>(e.push(a.role_id),{value:a.role_id,text:a.role_name}))),-1===e.indexOf("admin")&&this.roles.unshift({value:"admin",text:"超级管理员"})})).catch((a=>{n({title:"提示",content:a.message,showCancel:!1})}))},loadAppList(a){I.collection("opendb-app-list").limit(500).get().then((e=>{let t=e.result.data.map(((a,e)=>({value:a.appid,text:a.name})));t||(t=[]),a.map((a=>{t.find((e=>e.value===a))||(this.unknownAppids.push(a),t.push({value:a,text:`未知应用${a}`}))})),this.appList=t})).catch((a=>{n({title:"提示",content:a.message,showCancel:!1})}))},parseUserStatus:a=>0===a?"启用":1===a?"禁用":2===a?"审核中":3===a?"审核拒绝":4===a?"已注销":void 0!==a?"未知":"启用"},computed:{unknownAppidsCom(){let a="";return this.unknownAppids.map(((e,t)=>{a+=e,t!==this.unknownAppids.length-1&&(a+="、")})),a}}},[["render",function(a,e,t,s,l,o){const i=k(D("uni-easyinput"),x),n=k(D("uni-forms-item"),y),r=p,C=k(D("uni-data-checkbox"),A),I=_,L=w,U=V,T=k(D("uni-forms"),v);return u(),d(r,{class:"uni-container"},{default:m((()=>[c(T,{ref:"form",modelValue:l.formData,"onUpdate:modelValue":e[13]||(e[13]=a=>l.formData=a),rules:l.rules,validateTrigger:"bind",onSubmit:o.submit},{default:m((()=>[c(n,{name:"username",label:"用户名",required:""},{default:m((()=>[c(i,{modelValue:l.formData.username,"onUpdate:modelValue":e[0]||(e[0]=a=>l.formData.username=a),clearable:!1,placeholder:"请输入用户名"},null,8,["modelValue"])])),_:1}),c(n,{name:"nickname",label:"用户昵称",required:""},{default:m((()=>[c(i,{modelValue:l.formData.nickname,"onUpdate:modelValue":e[1]||(e[1]=a=>l.formData.nickname=a),clearable:!1,placeholder:"请输入用户昵称"},null,8,["modelValue"])])),_:1}),l.showPassword?(u(),d(n,{name:"password",label:"重置密码",key:"password"},{default:m((()=>[c(i,{modelValue:l.formData.password,"onUpdate:modelValue":e[2]||(e[2]=a=>l.formData.password=a),clearable:!1,placeholder:"请输入重置密码"},{default:m((()=>[c(r,{slot:"right",class:"cancel-reset-password-btn",onClick:o.trigger},{default:m((()=>[f("取消")])),_:1},8,["onClick"])])),_:1},8,["modelValue"])])),_:1})):(u(),d(n,{key:1,label:"重置密码"},{default:m((()=>[h("span",{class:"reset-password-btn",onClick:e[3]||(e[3]=(...a)=>o.trigger&&o.trigger(...a))},"点击重置密码")])),_:1})),c(n,{name:"role",label:"角色列表",class:"flex-center-x"},{default:m((()=>[c(C,{multiple:"",localdata:l.roles,modelValue:l.formData.role,"onUpdate:modelValue":e[4]||(e[4]=a=>l.formData.role=a)},null,8,["localdata","modelValue"])])),_:1}),c(n,{name:"tags",label:"用户标签",labelWidth:"100",class:"flex-center-x"},{default:m((()=>[c(C,{ref:"checkboxTags",multiple:!0,modelValue:l.formData.tags,"onUpdate:modelValue":e[5]||(e[5]=a=>l.formData.tags=a),collection:"uni-id-tag",field:"tagid as value, name as text"},null,8,["modelValue"]),h("span",{class:"link-btn",onClick:e[6]||(e[6]=(...a)=>o.gotoTagAdd&&o.gotoTagAdd(...a))},"新增"),h("span",{class:"link-btn",onClick:e[7]||(e[7]=(...a)=>o.gotoTagList&&o.gotoTagList(...a)),style:{"margin-left":"10px"}},"管理")])),_:1}),c(n,{name:"authorizedApp",label:"可登录应用"},{default:m((()=>[c(r,{class:"uni-forms-item-flex-center-x"},{default:m((()=>[c(C,{multiple:!0,modelValue:l.formData.authorizedApp,"onUpdate:modelValue":e[8]||(e[8]=a=>l.formData.authorizedApp=a),localdata:l.appList},null,8,["modelValue","localdata"]),h("span",{class:"link-btn",onClick:e[9]||(e[9]=(...a)=>o.gotoAppList&&o.gotoAppList(...a))},"管理")])),_:1}),a.formDataId===l.userId?(u(),d(r,{key:0,class:"uni-form-item-tips"},{default:m((()=>[f("当前有未添加的应用"+b(o.unknownAppidsCom)+"，建议点击右侧管理进行添加",1)])),_:1})):g("",!0)])),_:1}),c(n,{name:"mobile",label:"手机号"},{default:m((()=>[c(i,{modelValue:l.formData.mobile,"onUpdate:modelValue":e[10]||(e[10]=a=>l.formData.mobile=a),clearable:!1,placeholder:"请输入手机号"},null,8,["modelValue"])])),_:1}),c(n,{name:"email",label:"邮箱"},{default:m((()=>[c(i,{modelValue:l.formData.email,"onUpdate:modelValue":e[11]||(e[11]=a=>l.formData.email=a),clearable:!1,placeholder:"请输入邮箱"},null,8,["modelValue"])])),_:1}),c(n,{name:"status",label:"用户状态"},{default:m((()=>[Number(l.formData.status)<2?(u(),d(I,{key:0,onChange:e[12]||(e[12]=e=>a.binddata("status",e.detail.value)),checked:l.formData.status,disabled:a.formDataId===l.userId},null,8,["checked","disabled"])):(u(),d(r,{key:1,class:"uni-form-item-empty"},{default:m((()=>[f(b(o.parseUserStatus(l.formData.status)),1)])),_:1})),a.formDataId===l.userId?(u(),d(r,{key:2,class:"uni-form-item-tips"},{default:m((()=>[f("请勿禁用当前登录的账号")])),_:1})):g("",!0)])),_:1}),c(r,{class:"uni-button-group"},{default:m((()=>[c(L,{style:{width:"100px"},type:"primary",class:"uni-button",onClick:o.submitForm},{default:m((()=>[f(b(a.$t("common.button.submit")),1)])),_:1},8,["onClick"]),c(U,{"open-type":"navigateBack",style:{"margin-left":"15px"}},{default:m((()=>[c(L,{style:{width:"100px"},class:"uni-button"},{default:m((()=>[f(b(a.$t("common.button.back")),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue","rules","onSubmit"])])),_:1})}],["__scopeId","data-v-fffd0daf"]]);export{U as default};
